<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>AnatoFlow v22 PRO</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="/assets/icon-192.png">

  <style>
    :root { --bg: #f5f6fa; --text: #1e293b; --card: #ffffff; --primary: #1e40af; --fab: #2563eb; }
    body.dark { --bg: #0f172a; --text: #e2e8f0; --card: #1e293b; --fab: #0ea5e9; }
    body { margin:0; background:var(--bg); color:var(--text); font-family:-apple-system,system-ui,sans-serif; }
    .container { padding:1.2rem; padding-bottom:8rem; }
    .card { background:var(--card); border-radius:16px; padding:1.8rem; margin-bottom:1.5rem; box-shadow:0 4px 20px rgba(0,0,0,0.08); }
    h1 { margin:0; font-size:2rem; color:var(--primary); text-align:center; }
    h2 { margin:0 0 1rem; color:var(--primary); }
    input, select, textarea { width:100%; padding:1rem; margin:0.8rem 0; border-radius:12px; border:1px solid #cbd5e1; font-size:1.1rem; box-sizing:border-box; }
    button { background:var(--primary); color:white; border:none; padding:1rem; border-radius:12px; font-size:1.1rem; font-weight:600; cursor:pointer; }
    .fab { position:fixed; bottom:6.5rem; right:1.5rem; width:60px; height:60px; background:var(--fab); border-radius:50%; box-shadow:0 6px 20px rgba(37,99,235,0.4); font-size:2rem; z-index:100; }
    .required { color:#ef4444; }
    .tab { display:none; }
    .tab.active { display:block; }

    /* MENÚ INFERIOR PERFECTO */
    nav {
      position:fixed;
      bottom:0;
      left:0;
      width:100%;
      background:white;
      border-top:1px solid #ddd;
      z-index:999;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
    }
    nav::-webkit-scrollbar { display:none; }
    nav > div {
      display:flex;
      min-width:max-content;
      padding:0.5rem 0;
    }
    nav button {
      flex:0 0 auto;
      padding:1rem 1.5rem;
      border:none;
      background:none;
      font-weight:600;
      color:#64748b;
      white-space:nowrap;
    }
    nav button.active {
      color:var(--primary);
      border-top:4px solid var(--primary);
    }
  </style>
</head>
<body>

<header class="card" style="text-align:center;margin-bottom:1rem">
  <h1>AnatoFlow v22 PRO</h1>
  <p>Asistente profesional para técnicos de Anatomía Patológica</p>
</header>

<div class="container">

  <!-- DATOS DE LA MUESTRA -->
  <div id="home" class="tab active">
    <div class="card">
      <h2>Datos de la Muestra</h2>

      <label>Nº de muestra / Código <span class="required">*</span></label>
      <input type="text" id="codigoMuestra" required placeholder="Ej: 2025-00123">

      <label>Técnico / Responsable <span class="required">*</span></label>
      <input type="text" id="tecnico" required placeholder="Nombre y apellidos">

      <label>Fecha y hora de entrada</label>
      <input type="text" id="fechaEntrada" readonly>

      <label>Origen del tejido / Órgano <span class="required">*</span></label>
      <select id="organo" required>
        <option value="">Seleccionar órgano...</option>
        <optgroup label="Cabeza y Cuello">
          <option>Cerebro</option>
          <option>Ojos</option>
          <option>Oídos</option>
          <option>Lengua</option>
          <option>Tiroides</option>
          <option>Laringe</option>
          <option>Glándulas salivales</option>
        </optgroup>
        <optgroup label="Tórax">
          <option>Corazón</option>
          <option>Pulmones</option>
          <option>Esófago</option>
          <option>Timo</option>
          <option>Mama</option>
        </optgroup>
        <optgroup label="Abdomen">
          <option>Estómago</option>
          <option>Hígado</option>
          <option>Páncreas</option>
          <option>Vesícula Biliar</option>
          <option>Bazo</option>
          <option>Intestino Delgado</option>
          <option>Colon</option>
          <option>Recto</option>
          <option>Apéndice</option>
          <option>Riñones</option>
          <option>Glándulas Suprarrenales</option>
        </optgroup>
        <optgroup label="Pelvis">
          <option>Vejiga</option>
          <option>Útero</option>
          <option>Ovarios</option>
          <option>Próstata</option>
          <option>Testículos</option>
        </optgroup>
        <optgroup label="Otros tejidos">
          <option>Piel</option>
          <option>Linfonodo</option>
          <option>Médula ósea</option>
          <option>Tejido adiposo</option>
          <option>Músculo esquelético</option>
          <option>Hueso</option>
        </optgroup>
      </select>

      <label>Tipo de muestra <span class="required">*</span></label>
      <select id="tipoMuestra" required>
        <option value="">Seleccionar...</option>
        <option>Biopsia</option>
        <option>Pieza quirúrgica</option>
        <option>Citología</option>
        <option>Autopsia</option>
      </select>

      <label>Condición de llegada <span class="required">*</span></label>
      <select id="condicion" required>
        <option value="">Seleccionar...</option>
        <option>Formol al 10%</option>
        <option>Fresco</option>
        <option>Congelado</option>
        <option>Parafina</option>
        <option>Otro</option>
      </select>

      <label>Notas clínicas / Comentario</label>
      <textarea id="notas" rows="3" placeholder="Información clínica relevante..."></textarea>

      <button onclick="guardarDatosMuestra()" style="margin-top:1.5rem;background:#10b981">
        Guardar datos y Continuar
      </button>

      <div id="msgMuestra" style="margin-top:1rem;font-weight:600;color:#10b981"></div>
    </div>
  </div>

  <!-- PESTAÑAS -->
  <div id="protocolos" class="tab container"><div class="card"><h2>Protocolos</h2>Cargando…</div></div>
  <div id="timer" class="tab container"><div class="card"><h2>Timer</h2>Cargando…</div></div>
  <div id="inventario" class="tab container"><div class="card"><h2>Inventario</h2>Cargando…</div></div>
  <div id="ia" class="tab container"><div class="card"><h2>Analizador IA</h2>Cargando…</div></div>
  <div id="informe" class="tab container"><div class="card"><h2>Informe</h2>Cargando…</div></div>
</div>

<button class="fab" onclick="window.scrollTo({top:0,behavior:'smooth'})">↑</button>

<!-- MENÚ INFERIOR -->
<nav>
  <div>
    <button data-tab="home" class="active">Datos</button>
    <button data-tab="protocolos">Protocolos</button>
    <button data-tab="timer">Timer</button>
    <button data-tab="inventario">Inventario</button>
    <button data-tab="ia">IA</button>
    <button data-tab="informe">Informe</button>
  </div>
</nav>

<script>
// Fecha automática
document.getElementById('fechaEntrada').value = new Date().toLocaleString('es-ES');

// GUARDAR DATOS – SIN "OTROS"
function guardarDatosMuestra() {
  const organo = document.getElementById("organo").value || "No indicado";

  const datos = {
    codigo: document.getElementById('codigoMuestra').value.trim(),
    tecnico: document.getElementById('tecnico').value.trim(),
    fecha: document.getElementById('fechaEntrada').value,
    organo: organo,
    tipo: document.getElementById('tipoMuestra').value,
    condicion: document.getElementById('condicion').value,
    notas: document.getElementById('notas').value.trim(),
    guardadoEn: new Date().toISOString()
  };

  if (!datos.codigo || !datos.tecnico || datos.organo === "No indicado" || !datos.tipo || !datos.condicion) {
    alert("Por favor completa todos los campos obligatorios");
    return;
  }

  localStorage.setItem("anatoflow_muestra_v22", JSON.stringify(datos));
  document.getElementById("msgMuestra").textContent = "Datos guardados correctamente";
  document.getElementById("msgMuestra").style.color = "#10b981";

  document.querySelector('[data-tab="protocolos"]').click();
}

// CARGAR DATOS
window.addEventListener('load', () => {
  const saved = localStorage.getItem('anatoflow_muestra_v22');
  if (saved) {
    const d = JSON.parse(saved);
    document.getElementById('codigoMuestra').value = d.codigo || '';
    document.getElementById('tecnico').value = d.tecnico || '';
    document.getElementById('organo').value = d.organo || '';
    document.getElementById('tipoMuestra').value = d.tipo || '';
    document.getElementById('condicion').value = d.condicion || '';
    document.getElementById('notas').value = d.notas || '';
    document.getElementById('msgMuestra').textContent = 'Datos cargados de sesión anterior';
    document.getElementById('msgMuestra').style.color = '#3b82f6';
  }
});
</script>

<script src="js/ui.js"></script>
<script src="js/protocols.js"></script>
<script src="js/timer.js"></script>
<script src="js/inventory.js"></script>
<script src="js/ai-final.js"></script>
<script src="js/report.js"></script>

</body>
</html>
