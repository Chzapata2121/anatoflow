<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>AnatoFlow v22 PRO</title>

  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="/assets/icon-192.png">

  <style>
    :root { --bg: #f5f6fa; --text: #1e293b; --card: #ffffff; --primary: #1e40af; --fab: #2563eb; }
    body.dark { --bg: #0f172a; --text: #e2e8f0; --card: #1e293b; --fab: #0ea5e9; }
    body { margin:0; background:var(--bg); color:var(--text); font-family:-apple-system,system-ui,sans-serif; }
    .container { padding:1.2rem; padding-bottom:8rem; }
    .card { background:var(--card); border-radius:16px; padding:1.8rem; margin-bottom:1.5rem; box-shadow:0 4px 20px rgba(0,0,0,0.08); }
    h1 { margin:0; font-size:2rem; color:var(--primary); text-align:center; }
    h2 { margin:0 0 1rem; color:var(--primary); }
    input, select, textarea { width:100%; padding:1rem; margin:0.8rem 0; border-radius:12px; border:1px solid #cbd5e1; font-size:1.1rem; box-sizing:border-box; }
    button { background:var(--primary); color:white; border:none; padding:1rem; border-radius:12px; font-size:1.1rem; font-weight:600; cursor:pointer; }
    .fab { position:fixed; bottom:6.5rem; right:1.5rem; width:60px; height:60px; background:var(--fab); border-radius:50%; box-shadow:0 6px 20px rgba(37,99,235,0.4); font-size:2rem; z-index:100; }
    .required { color:#ef4444; }
    .tab { display:none; }
    .tab.active { display:block; }

    /* MEN√ö INFERIOR ‚Äì SCROLL PERFECTO EN M√ìVIL */
    nav {
      position:fixed;
      bottom:0;
      left:0;
      width:100%;
      background:white;
      border-top:1px solid #ddd;
      z-index:999;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
    }
    nav::-webkit-scrollbar { display:none; }
    nav > div {
      display:flex;
      min-width:max-content;
      padding:0.5rem 0;
    }
    nav button {
      flex:0 0 auto;
      padding:1rem 1.5rem;
      border:none;
      background:none;
      font-weight:600;
      color:#64748b;
      white-space:nowrap;
    }
    nav button.active {
      color:var(--primary);
      border-top:4px solid var(--primary);
    }
  </style>
</head>
<body>

<header class="card" style="text-align:center;margin-bottom:1rem">
  <h1>AnatoFlow v22 PRO</h1>
  <p>Asistente profesional para t√©cnicos de Anatom√≠a Patol√≥gica</p>
</header>

<div class="container">

  <div id="home" class="tab active">
    <div class="card">
      <h2>Datos de la Muestra</h2>

      <label>N¬∫ de muestra / C√≥digo <span class="required">*</span></label>
      <input type="text" id="codigoMuestra" required placeholder="Ej: 2025-00123">

      <label>T√©cnico / Responsable <span class="required">*</span></label>
      <input type="text" id="tecnico" required placeholder="Nombre y apellidos">

      <label>Fecha y hora de entrada</label>
      <input type="text" id="fechaEntrada" readonly>

      <label>Origen del tejido / √ìrgano <span class="required">*</span></label>
      <select id="organo" required>
        <option value="">Seleccionar √≥rgano...</option>
        <optgroup label="Cabeza y Cuello">
          <option>Cerebro</option><option>Ojos</option><option>O√≠dos</option><option>Lengua</option>
          <option>Tiroides</option><option>Laringe</option><option>Gl√°ndulas salivales</option>
        </optgroup>
        <optgroup label="T√≥rax">
          <option>Coraz√≥n</option><option>Pulmones</option><option>Es√≥fago</option><option>Timo</option><option>Mama</option>
        </optgroup>
        <optgroup label="Abdomen">
          <option>Est√≥mago</option><option>H√≠gado</option><option>P√°ncreas</option>
          <option>Ves√≠cula Biliar</option><option>Bazo</option><option>Intestino Delgado</option>
          <option>Colon</option><option>Recto</option><option>Ap√©ndice</option>
          <option>Ri√±ones</option><option>Gl√°ndulas Suprarrenales</option>
        </optgroup>
        <optgroup label="Pelvis">
          <option>Vejiga</option><option>√ötero</option><option>Ovarios</option>
          <option>Pr√≥stata</option><option>Test√≠culos</option>
        </optgroup>
        <optgroup label="Otros tejidos">
          <option>Piel</option><option>Linfonodo</option><option>M√©dula √≥sea</option>
          <option>Tejido adiposo</option><option>M√∫sculo esquel√©tico</option><option>Hueso</option>
        </optgroup>
      </select>

      <label>Tipo de muestra <span class="required">*</span></label>
      <select id="tipoMuestra" required>
        <option value="">Seleccionar...</option>
        <option>Biopsia</option><option>Pieza quir√∫rgica</option><option>Citolog√≠a</option><option>Autopsia</option>
      </select>

      <label>Condici√≥n de llegada <span class="required">*</span></label>
      <select id="condicion" required>
        <option value="">Seleccionar...</option>
        <option>Formol al 10%</option><option>Fresco</option><option>Congelado</option>
        <option>Parafina</option><option>Otro</option>
      </select>

      <label>Notas cl√≠nicas / Comentario</label>
      <textarea id="notas" rows="3" placeholder="Informaci√≥n cl√≠nica relevante..."></textarea>

      <button **onclick="guardarDatosMuestra()"** style="margin-top:1.5rem;background:#10b981">
        Guardar datos y Continuar
      </button>

      <div id="msgMuestra" style="margin-top:1rem;font-weight:600;color:#10b981"></div>
    </div>
  </div>

  <div id="protocolos" class="tab container"><div class="card"><h2>Protocolos</h2>Cargando‚Ä¶</div></div>
  <div id="timer" class="tab container"><div class="card"><h2>Timer</h2>Cargando‚Ä¶</div></div>
  <div id="inventario" class="tab container"><div class="card"><h2>Inventario</h2>Cargando‚Ä¶</div></div>
  <div id="ia" class="tab container">
  <div class="card">
    <h2>Analizador IA</h2>
    <p style="text-align:center">Sube o fotograf√≠a el corte histol√≥gico</p>

    <div style="text-align:center;margin:2rem 0">
      <strong>Modo activo:</strong><br><br>
      <div style="display:flex;flex-direction:column;gap:1.5rem;align-items:center">
        <button id="localBtn" class="modoBtn active" style="width:90%;padding:1.5rem;font-size:1.3rem;border-radius:16px;background:#e0e7ff;border:3px solid #6366f1">
          <span style="font-size:3rem">üì¥</span><br>
          <strong style="font-size:1.4rem;color:#4338ca">LOCAL</strong><br>
          <small style="color:#6366f1">Offline ¬∑ Siempre funciona</small>
        </button>
        <button id="geminiBtn" class="modoBtn" style="width:90%;padding:1.5rem;font-size:1.3rem;border-radius:16px;background:#f0fdf4;border:3px solid #10b981">
          <span style="font-size:3rem">üåê</span><br>
          <strong style="font-size:1.4rem;color:#166534">GEMINI</strong><br>
          <small style="color:#16a34a">IA real ¬∑ Solo con clave</small>
        </button>
      </div>
    </div>

    <div id="iaActivaMsg" style="display:none;text-align:center;margin:2rem 0;padding:1.2rem;background:#ecfdf5;border-radius:12px;border:2px solid #10b981;color:#166534;font-weight:bold;font-size:1.2rem">
      ‚úì IA real (Gemini) activada
    </div>

    <div id="claveDiv" style="display:none;margin:2rem 0">
      <input type="password" id="geminiInput" placeholder="Pega tu clave Gemini AIza..." style="width:100%;padding:1.2rem;border-radius:12px;border:1px solid #cbd5e1;font-size:1.1rem">
      <div style="margin-top:1rem;text-align:center">
        <button id="saveKeyBtn" style="padding:0.8rem 2rem">Activar IA real</button>
        <button id="cancelKeyBtn" style="background:#6b7280;color:white;margin-left:1rem;padding:0.8rem 2rem">Cancelar</button>
      </div>
    </div>

    <div style="display:flex;gap:2rem;justify-content:center;margin:3rem 0;flex-wrap:wrap">
      <button id="uploadBtn" style="padding:1.5rem 3rem;font-size:1.4rem;border-radius:16px;background:#1e40af;color:white">Subir imagen</button>
      <button id="camBtn" style="padding:1.5rem 3rem;font-size:1.4rem;border-radius:16px;background:#1e40af;color:white">C√°mara</button>
    </div>

    <input type="file" id="fileInput" accept="image/*" style="display:none">
    <input type="file" id="camInput" accept="image/*" capture="environment" style="display:none">

    <div id="preview" style="text-align:center;margin:2rem 0"></div>

    <div style="text-align:center;margin:2rem 0">
      <button id="analyzeBtn" disabled style="padding:1.5rem 4rem;font-size:1.5rem;border-radius:20px;background:#1e40af;color:white">Analizar</button>
    </div>

    <div id="result" style="margin-top:1rem"></div>
  </div>
</div>
  <div id="informe" class="tab container"><div class="card"><h2>Informe</h2>Cargando‚Ä¶</div></div>
</div>

<button class="fab" onclick="window.scrollTo({top:0,behavior:'smooth'})">‚Üë</button>

<nav>
  <div>
    <button data-tab="home" class="active">Datos</button>
    <button data-tab="protocolos">Protocolos</button>
    <button data-tab="timer">Timer</button>
    <button data-tab="inventario">Inventario</button>
    <button data-tab="ia">IA</button>
    <button data-tab="informe">Informe</button>
  </div>
</nav>

<script>
// Funci√≥n para manejo de pesta√±as
function navigateToTab(tabId) {
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    document.getElementById(tabId).classList.add('active');
    
    document.querySelectorAll('nav button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`nav button[data-tab="${tabId}"]`).classList.add('active');
}

// L√≥gica de navegaci√≥n para el men√∫ inferior
document.querySelectorAll('nav button').forEach(button => {
    button.addEventListener('click', function() {
        navigateToTab(this.getAttribute('data-tab'));
    });
});

// Funci√≥n Fecha autom√°tica
document.getElementById('fechaEntrada').value = new Date().toLocaleString('es-ES');

// üíæ FUNCI√ìN GUARDAR DATOS Y CONTINUAR (Asignada al onclick)
function guardarDatosMuestra() {
  const organo = document.getElementById("organo").value || "No indicado";

  const datos = {
    codigo: document.getElementById('codigoMuestra').value.trim(),
    tecnico: document.getElementById('tecnico').value.trim(),
    fecha: document.getElementById('fechaEntrada').value,
    organo: organo,
    tipo: document.getElementById('tipoMuestra').value,
    condicion: document.getElementById('condicion').value,
    notas: document.getElementById('notas').value.trim(),
    guardadoEn: new Date().toISOString()
  };

  if (!datos.codigo || !datos.tecnico || datos.organo === "No indicado" || !datos.tipo || !datos.condicion) {
    alert("Por favor completa todos los campos obligatorios");
    return;
  }

  // Clave de localStorage para los datos de la muestra
  localStorage.setItem("anatoflow_muestra_v22", JSON.stringify(datos));
  document.getElementById("msgMuestra").textContent = "Datos guardados correctamente";
  document.getElementById("msgMuestra").style.color = "#10b981";

  // Pasar a Protocolos usando la funci√≥n de navegaci√≥n
  navigateToTab("protocolos");
  window.scrollTo({top:0,behavior:'smooth'}); // Regresar arriba de la nueva pesta√±a
}
</script>

<script src="js/ui.js"></script>
<script src="js/protocols.js"></script>
<script src="js/timer.js"></script>
<script src="js/inventory.js"></script>
<script src="js/ai-final.js"></script>
<script src="js/report.js"></script>

</body>
</html>
